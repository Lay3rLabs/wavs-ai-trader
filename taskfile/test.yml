version: "3"

includes:
  config:
    taskfile: ./config.yml
    flatten: true

tasks:
  contract-off-chain:
    requires:
      vars: [CONTRACT]
    vars:
      CONTRACT_SRC_NAME:
        sh: task contracts:src-name CONTRACT_KIND={{.CONTRACT}}
    cmds:
      - echo "Testing {{.CONTRACT}} off-chain"
      - cd packages/tests/off-chain && cargo test --test {{.CONTRACT_SRC_NAME}}
      - cd packages/contracts/{{.CONTRACT}} && cargo test

  off-chain:
    cmds:
      - echo "Testing off-chain"
      - cd packages/tests/off-chain && cargo test
      - for: { var: ALL_CONTRACTS }
        cmd: cd packages/contracts/{{.ITEM}} && cargo test

  contract-on-chain:
    requires:
      vars: [CONTRACT]
    vars:
      CONTRACT_SRC_NAME:
        sh: task contracts:src-name CONTRACT_KIND={{.CONTRACT}}
    cmds:
      - echo "Testing {{.CONTRACT}} on-chain"
      - cd packages/tests/on-chain && cargo test --test {{.CONTRACT_SRC_NAME}}

  on-chain:
    cmds:
      - echo "Testing on-chain"
      - cd packages/tests/on-chain && cargo test -- --test-threads 1
